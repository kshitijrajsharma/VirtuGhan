<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sentinel-2 COG Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      body {
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      #map {
        flex: 1;
      }
      #info {
        position: absolute;
        bottom: 10px;
        left: 10px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      }
      #controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      }
      #sidebar {
        display: none;
        position: absolute;
        top: 10px;
        right: 10px;
        width: 300px;
        max-height: 80vh;
        overflow-y: auto;
        padding: 10px;
        background: white;
        border: 1px solid #ccc;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }
      .feature-item {
        padding: 5px;
        border-bottom: 1px solid #ccc;
        cursor: pointer;
      }
      .feature-item:hover {
        background-color: #f0f0f0;
      }
      .highlighted {
        background-color: #ff0;
      }
      .popup-content {
        max-height: 200px;
        overflow-y: auto;
      }
      .download-section {
        margin-top: 10px;
      }
      .download-section h4 {
        cursor: pointer;
      }
      .download-section ul {
        display: none;
        list-style-type: none;
        padding: 0;
      }
      .download-section ul li {
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="info">
      <strong>Coordinates:</strong> <span id="coords"></span><br />
      <strong>Zoom Level:</strong> <span id="zoom-level"></span>
    </div>
    <div id="controls">
      <label>Start Date: <input type="date" id="start-date" /></label><br />
      <label>End Date: <input type="date" id="end-date" /></label><br />
      <label
        >Cloud Cover: <input type="number" id="cloud-cover" value="30" /></label
      ><br />
      <button id="search-button">Search</button><br /><br />
      <input type="checkbox" id="overlayNdvi" />
      <label for="overlayNdvi">Overlay NDVI Layer</label>
    </div>
    <div id="sidebar">
      <h3>Features</h3>
      <button id="clear-sidebar-button">Clear</button>
      <div id="feature-list"></div>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      var map = L.map("map").setView([28.202082, 83.987222], 10);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      var geojsonLayer;
      var ndviLayer;
      var highlightedLayer;

      map.on("moveend", function () {
        var bounds = map.getBounds();
        var bbox = `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}`;
        document.getElementById("coords").textContent = bbox;
        document.getElementById("zoom-level").textContent = map.getZoom();
      });

      document
        .getElementById("search-button")
        .addEventListener("click", function () {
          var bounds = map.getBounds();
          var bbox = `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}`;
          var startDate = document.getElementById("start-date").value;
          var endDate = document.getElementById("end-date").value;
          var cloudCover = document.getElementById("cloud-cover").value;
          var overlayNdvi = document.getElementById("overlayNdvi").checked;

          fetch(
            `/search?bbox=${bbox}&start_date=${startDate}&end_date=${endDate}&cloud_cover=${cloudCover}`
          )
            .then((response) => response.json())
            .then((data) => {
              if (geojsonLayer) {
                map.removeLayer(geojsonLayer);
              }

              geojsonLayer = L.geoJSON(data, {
                style: function (feature) {
                  return {
                    fillOpacity: 0,
                    color: "red",
                    weight: 1,
                  };
                },
                onEachFeature: function (feature, layer) {
                  layer.on("click", function () {
                    var popupContent = `
                                <div class="popup-content">
                                    <strong>ID:</strong> ${feature.id}<br />
                                    <strong>Date:</strong> ${
                                      feature.properties.datetime
                                    }<br />
                                    <strong>Cloud Cover:</strong> ${
                                      feature.properties["eo:cloud_cover"]
                                    }<br />
                                    <hr>
                                    <strong>Properties:</strong><br />
                                    ${Object.entries(feature.properties)
                                      .map(
                                        ([key, value]) =>
                                          `<strong>${key}:</strong> ${value}<br />`
                                      )
                                      .join("")}
                                    <div class="download-section">
                                        <h4>Download</h4>
                                        <ul>
                                            ${Object.entries(feature.assets)
                                              .map(
                                                ([key, asset]) =>
                                                  `<li><a href="${asset.href}" target="_blank">${asset.title}</a></li>`
                                              )
                                              .join("")}
                                        </ul>
                                    </div>
                                </div>
                              `;
                    layer.bindPopup(popupContent).openPopup();

                    // Add event listener for download section toggle
                    document
                      .querySelector(".download-section h4")
                      .addEventListener("click", function () {
                        var ul = this.nextElementSibling;
                        ul.style.display =
                          ul.style.display === "none" ? "block" : "none";
                      });
                  });
                },
              }).addTo(map);

              var featureList = document.getElementById("feature-list");
              featureList.innerHTML = "";

              data.features.forEach(function (feature, index) {
                var featureItem = document.createElement("div");
                featureItem.className = "feature-item";
                featureItem.innerHTML = `
                            <strong>ID:</strong> ${feature.id}<br />
                            <strong>Date:</strong> ${feature.properties.datetime}<br />
                            <strong>Cloud Cover:</strong> ${feature.properties["eo:cloud_cover"]}<br />
                        `;
                featureItem.addEventListener("click", function () {
                  if (highlightedLayer) {
                    map.removeLayer(highlightedLayer);
                  }
                  highlightedLayer = L.geoJSON(feature, {
                    style: function () {
                      return {
                        fillOpacity: 0.5,
                        color: "yellow",
                        weight: 2,
                      };
                    },
                  }).addTo(map);
                  map.fitBounds(highlightedLayer.getBounds());
                  var popupContent = `
            <div class="popup-content">
                <strong>ID:</strong> ${feature.id}<br />
                <strong>Date:</strong> ${feature.properties.datetime}<br />
                <strong>Cloud Cover:</strong> ${
                  feature.properties["eo:cloud_cover"]
                }<br />
                <hr>
                <strong>Properties:</strong><br />
                ${Object.entries(feature.properties)
                  .map(
                    ([key, value]) => `<strong>${key}:</strong> ${value}<br />`
                  )
                  .join("")}
                <div class="download-section">
                    <h4>Download</h4>
                    <ul>
                        ${Object.entries(feature.assets)
                          .map(
                            ([key, asset]) =>
                              `<li><a href="${asset.href}" target="_blank">${asset.title}</a></li>`
                          )
                          .join("")}
                    </ul>
                </div>
            </div>
        `;
                  highlightedLayer.bindPopup(popupContent).openPopup();

                  document
                    .querySelector(".download-section h4")
                    .addEventListener("click", function () {
                      var ul = this.nextElementSibling;
                      ul.style.display =
                        ul.style.display === "none" ? "block" : "none";
                    });
                });
                featureList.appendChild(featureItem);
              });

              document.getElementById("sidebar").style.display = "block";

              if (overlayNdvi) {
                if (ndviLayer) {
                  map.removeLayer(ndviLayer);
                }

                ndviLayer = L.tileLayer(
                  `/tile/{z}/{x}/{y}?start_date=${startDate}&end_date=${endDate}&cloud_cover=${cloudCover}`,
                  {
                    tileSize: 256,
                    opacity: 0.8,
                    attribution:
                      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                  }
                ).addTo(map);
              }
            });
        });

      document
        .getElementById("clear-sidebar-button")
        .addEventListener("click", function () {
          if (geojsonLayer) {
            map.removeLayer(geojsonLayer);
          }
          if (highlightedLayer) {
            map.removeLayer(highlightedLayer);
          }
          if (ndviLayer) {
            map.removeLayer(ndviLayer);
          }
          document.getElementById("sidebar").style.display = "none";
        });

      // Set default dates
      var today = new Date().toISOString().split("T")[0];
      var lastYear = new Date();
      lastYear.setFullYear(lastYear.getFullYear() - 1);
      var lastYearDate = lastYear.toISOString().split("T")[0];

      document.getElementById("start-date").value = lastYearDate;
      document.getElementById("end-date").value = today;
    </script>
  </body>
</html>
