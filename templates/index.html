<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sentinel-2 COG Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <!-- tailwind start -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

    <!-- for customization -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              clifford: '#da373d',
            }
          }
        }
      }
    </script>

  <!-- for custom css -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
    }
  </style>
    <!-- tailwind end -->
    <style>
      body {
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      /* Custom thin scrollbar styles */
      .custom-scrollbar::-webkit-scrollbar {
        width: 5px;
        height: 5px;
      }

      .custom-scrollbar::-webkit-scrollbar-track {
        border-radius: 100vh;
        background: #fbfaf8;
      }

      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #b0b0b0;
        border-radius: 100vh;
        border: 3px solid rgb(86, 86, 86);
      }

      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #494949;
      }
      /* Custom styles for the icon hover effect */ 
      #clear-sidebar-button:hover { 
        color: #1f2937; 
        /* Tailwind's gray-900 */ 
        cursor: pointer;
      }
    </style>
    <style>
      #map {
          height: 500px;
          width: 100%;
      }
      .draw-buttons {
          display: flex;
          justify-content: center;
          margin-bottom: 10px;
      }
      .draw-buttons button {
          margin: 0 5px;
          padding: 10px;
          cursor: pointer;
      }
  </style>
  <style>
    .upload-area.dragover {
        border-color: #4A5568; /* Tailwind gray-700 */
        background-color: #EDF2F7; /* Tailwind gray-100 */
    }
  </style>

  </head>
  <body>
    <header class="bg-white shadow-md py-4 border-b border-gray-300">
      <div class="container mx-auto flex items-center justify-between px-4">
        <!-- Logo -->
        <div class="flex items-center">
          <img src="static/img/ku_logo.png" alt="Logo" class="h-10 w-10 mr-2">
          <span class="text-xl font-bold text-gray-800">KU VData Cube</span>
        </div>
        <!-- Navigation Links -->
        <nav class="flex space-x-8">
          <a href="#map" class="text-gray-600 hover:text-gray-900">Data</a>
          <a href="#about" class="text-gray-600 hover:text-gray-900">About</a>
        </nav>
      </div>
    </header>
    <div class = "flex flex-col md:flex-row h-screen overflow-y-auto custom-scrollbar md:overflow-hidden">
      <div id="info" class="w-full md:w-1/4 space-y-12 bg-gray-50 z-10 border-r border-gray-300">
      <div class="container mx-auto pb-4 pt-1">
        <div class="tabs">
          <div class="flex justify-center mb-2">
            <button id="filterTab" class="tab w-1/3 py-2 text-center text-gray-600 border-b-2 border-transparent hover:border-blue-500 focus:outline-none focus:border-blue-500">Live View</button>
            <button id="resultTab" class="tab w-1/3 py-2 text-center text-gray-600 border-b-2 border-transparent hover:border-blue-500 focus:outline-none focus:border-blue-500">Result</button>
            <button id="exportTab" class="tab w-1/3 py-2 text-center text-gray-600 border-b-2 border-transparent hover:border-blue-500 focus:outline-none focus:border-blue-500">Export</button>
          </div>
          <div class="tab-content">
            <div class="tab-panel hidden">
      
            <div class="border-b border-gray-900/10 p-4">
              <!-- <h2 class="text-base/7 font-semibold text-gray-900">Apply Filters</h2>
              <p class="mt-1 text-sm/6 text-gray-600">Select the filters you want to apply.</p> -->
              <div class = "pb-4">
                <label id="listbox-label" class="block text-sm/6 font-medium text-gray-900">Filter Option</label>
                <div class="relative mt-2">
                  <button id="select-button" type="button" class="cursor-pointer grid w-full cursor-default grid-cols-1 rounded-md bg-white py-1.5 pl-3 pr-2 text-left text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="listbox-label">
                    <span class="col-start-1 row-start-1 flex items-center gap-3 pr-6">
                      <img src="static/img/select-icon.png" alt="" class="size-5 shrink-0 rounded-full">
                      <span id = "selected_filter_value" class="block truncate">Select Option</span>
                    </span>
                    <svg class="col-start-1 row-start-1 size-5 self-center justify-self-end text-gray-500 sm:size-4" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M5.22 10.22a.75.75 0 0 1 1.06 0L8 11.94l1.72-1.72a.75.75 0 1 1 1.06 1.06l-2.25 2.25a.75.75 0 0 1-1.06 0l-2.25-2.25a.75.75 0 0 1 0-1.06ZM10.78 5.78a.75.75 0 0 1-1.06 0L8 4.06 6.28 5.78a.75.75 0 0 1-1.06-1.06l2.25-2.25a.75.75 0 0 1 1.06 0l2.25 2.25a.75.75 0 0 1 0 1.06Z" clip-rule="evenodd" />
                    </svg>
                  </button>
              
                  <ul id="select-list" class="hidden absolute z-10 mt-1 max-h-56 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black/5 focus:outline-none sm:text-sm" tabindex="-1" role="listbox" aria-labelledby="listbox-label" aria-activedescendant="listbox-option-3">
                    <li class="template-filters relative select-none py-2 pl-3 pr-9 text-gray-900 cursor-pointer hover:bg-gray-100" id="listbox-option-0" role="option">
                      <div class="flex items-center">
                        <img src="static/img/ndvi.png" alt="" class="size-5 shrink-0 rounded-full">
                        <span class="template-filters-value ml-3 block truncate font-normal" value= "NDVI">NDVI</span>
                      </div>
                      <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-indigo-600">
                        <svg class="size-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                          <!-- <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.05-.143Z" clip-rule="evenodd" /> -->
                        </svg>
                      </span>
                    </li>
                    <!-- More items... -->
                    <li class="template-filters relative select-none py-2 pl-3 pr-9 text-gray-900 cursor-pointer hover:bg-gray-100" id="listbox-option-1" role="option">
                      <div class="flex items-center">
                        <img src="static/img/basemap.png" alt="" class="size-5 shrink-0 rounded-full">
                        <span class="template-filters-value ml-3 block truncate font-normal" value = "NDWI">NDWI</span>
                      </div>
                      <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-indigo-600">
                        <svg class="size-0" viewBox="" fill="currentColor" aria-hidden="true">
                          <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.05-.143Z" clip-rule="evenodd" />
                        </svg>
                      </span>
                    </li>
                    <hr/>
                    <li id = "custom-filter" class="relative select-none py-2 pl-3 pr-9 text-gray-900 cursor-pointer hover:bg-gray-100" id="listbox-option-1" role="option">
                      <div class="flex items-center">
                        <img src="static/img/plus.png" alt="" class="size-5 shrink-0 rounded-full">
                        <span class="ml-3 block truncate font-normal text-blue-500">Custom Filter</span>
                      </div>
                      <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-indigo-600">
                        <svg class="size-0" viewBox="" fill="currentColor" aria-hidden="true">
                          <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.05-.143Z" clip-rule="evenodd" />
                        </svg>
                      </span>
                    </li>
                  </ul>
                </div>
                <label id = "formulaHeading" class="block text-xs font-medium text-gray-600 pb-1 pt-1 hidden">Custom: <span id="formulaText" class = "break-words w-64 text-xs text-gray-500" ></span></label>
              </div>
              <div class = "pb-4">
                <label class="block text-sm/6 font-medium text-gray-900 pb-4">Select Date</label>
                <div class="relative h-10 w-full min-w-[200px] mb-4">
                  <input id="start-date" class="bg-white my-dates peer h-full w-full rounded-[7px] border border-blue-gray-200 border-t-transparent bg-transparent px-3 py-2.5 font-sans text-sm font-normal text-blue-gray-700 outline outline-0 transition-all placeholder-shown:border placeholder-shown:border-blue-gray-200 placeholder-shown:border-t-blue-gray-200 focus:border-2 focus:border-gray-900 focus:border-t-transparent focus:outline-0 disabled:border-0 disabled:bg-blue-gray-50" placeholder=" "/>
                  <label id = "start-date" class="before:content[' '] after:content[' '] pointer-events-none absolute left-0 -top-1.5 flex h-full w-full select-none !overflow-visible truncate text-[11px] font-normal leading-tight text-gray-500 transition-all before:pointer-events-none before:mt-[6.5px] before:mr-1 before:box-border before:block before:h-1.5 before:w-2.5 before:rounded-tl-md before:border-t before:border-l before:border-blue-gray-200 before:transition-all after:pointer-events-none after:mt-[6.5px] after:ml-1 after:box-border after:block after:h-1.5 after:w-2.5 after:flex-grow after:rounded-tr-md after:border-t after:border-r after:border-blue-gray-200 after:transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:leading-[3.75] peer-placeholder-shown:text-blue-gray-500 peer-placeholder-shown:before:border-transparent peer-placeholder-shown:after:border-transparent peer-focus:text-[11px] peer-focus:leading-tight peer-focus:text-gray-900 peer-focus:before:border-t-2 peer-focus:before:border-l-2 peer-focus:before:!border-gray-900 peer-focus:after:border-t-2 peer-focus:after:border-r-2 peer-focus:after:!border-gray-900 peer-disabled:text-transparent peer-disabled:before:border-transparent peer-disabled:after:border-transparent peer-disabled:peer-placeholder-shown:text-blue-gray-500">
                    Start Date
                  </label>
                </div>
                <div class="relative h-10 w-full min-w-[200px]">
                  <input id="end-date" class="bg-white my-dates peer h-full w-full rounded-[7px] border border-blue-gray-200 border-t-transparent bg-transparent px-3 py-2.5 font-sans text-sm font-normal text-blue-gray-700 outline outline-0 transition-all placeholder-shown:border placeholder-shown:border-blue-gray-200 placeholder-shown:border-t-blue-gray-200 focus:border-2 focus:border-gray-900 focus:border-t-transparent focus:outline-0 disabled:border-0 disabled:bg-blue-gray-50" placeholder=" "/>
                  <label id = "" class="before:content[' '] after:content[' '] pointer-events-none absolute left-0 -top-1.5 flex h-full w-full select-none !overflow-visible truncate text-[11px] font-normal leading-tight text-gray-500 transition-all before:pointer-events-none before:mt-[6.5px] before:mr-1 before:box-border before:block before:h-1.5 before:w-2.5 before:rounded-tl-md before:border-t before:border-l before:border-blue-gray-200 before:transition-all after:pointer-events-none after:mt-[6.5px] after:ml-1 after:box-border after:block after:h-1.5 after:w-2.5 after:flex-grow after:rounded-tr-md after:border-t after:border-r after:border-blue-gray-200 after:transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:leading-[3.75] peer-placeholder-shown:text-blue-gray-500 peer-placeholder-shown:before:border-transparent peer-placeholder-shown:after:border-transparent peer-focus:text-[11px] peer-focus:leading-tight peer-focus:text-gray-900 peer-focus:before:border-t-2 peer-focus:before:border-l-2 peer-focus:before:!border-gray-900 peer-focus:after:border-t-2 peer-focus:after:border-r-2 peer-focus:after:!border-gray-900 peer-disabled:text-transparent peer-disabled:before:border-transparent peer-disabled:after:border-transparent peer-disabled:peer-placeholder-shown:text-blue-gray-500">
                    End Date
                  </label>
                </div>
              </div>
              <div>
                <label class="block text-sm/6 font-medium text-gray-900 pb-1">Select Cloud Cover <i title = "Less than the input value in percentage" class="fa-solid fa-circle-info"></i></label>
                
                <div class="bg-white mt-4">
                  <div class="relative bg-inherit">
                      <input type="number" id="cloud-cover" name="" value = "50" class="peer bg-transparent h-10 w-full rounded-lg text-gray-900 placeholder-transparent ring-1 px-2 ring-gray-200 focus:ring-sky-600 focus:outline-none focus:border-rose-600" placeholder="Cloud Cover"/><label for="" class="absolute cursor-text left-0 -top-3 text-sm text-gray-500 bg-inherit mx-1 px-1 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-2 peer-focus:-top-3 peer-focus:text-sky-600 peer-focus:text-sm transition-all">Cloud Cover</label>
                  </div>
                </div>
              </div>

              <div class="mt-4">
                <label class="block text-sm/6 font-medium text-gray-900 pb-1">BBOX: <span id="coords" class = "break-words w-64 text-xs text-gray-500" ></span></label>
                
                <label class="block text-sm/6 font-medium text-gray-900 pb-1">Zoom Level: <span class = "text-xs text-gray-500" id="zoom-level"></span></label>
              </div>

                <div class="pb-4 mt-6 float-right">
                  <button id="search-clear-button" class="clear-visualize-filter bg-transparent rounded-lg text-gray-500 text-sm text-center self-center px-3 py-2 my-2 mx-2"><i class="fa-solid fa-rotate-right"></i> Clear</button>
                  <button id="search-button" title= "Select Filter Above to Visualize" class="bg-gray-500 pointer-events-none text-white rounded-lg text-sm text-center self-center px-3 py-2 my-2 mx-2"><i class="fa-regular fa-eye"></i> Visualize</button>
                </div>
            </div>
            </div>
            <div class="tab-panel hidden p-4">
              <!-- Content for Tab 2 -->
              <div id="sidebar">
                <div class="flex items-center justify-between">
                  <label id = "display-image-count" class="block  font-medium text-gray-900 pb-4">Images: <span class="text-xs"><span></label>
                  <span id="clear-sidebar-button" class="clear-visualize-filter text-gray-500 text-xs"><i class="fa-solid fa-rotate-right"></i> Clear</span>
                </div>
                <div id="feature-list" style = "max-height: 450px;" class = "overflow-auto custom-scrollbar">
                  <label class="block text-sm font-medium text-gray-400 pt-4">Apply the Filter First!!!</label>
                </div>
              </div>
            </div>
            <div class="tab-panel hidden p-4">
              <!-- Content for Tab 3 -->
              <div id="sidebar1" class = "overflow-y-scroll custom-scrollbar" style = "max-height: 550px;">
               <div>
                <label class="block  font-medium text-gray-900 pb-4">Select Area of Interest </label>
                <!-- dropdown start -->
                <div class="relative mt-2">
                  <button id="select-button-bbox" type="button" class="grid w-full cursor-default grid-cols-1 rounded-md bg-white py-1.5 pl-3 pr-2 text-left text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="listbox-label">
                    <span class="col-start-1 row-start-1 flex items-center gap-3 pr-6">
                      <i class="fa-regular fa-square"></i>
                      <span id = "selected_filter_value_bbox" class="block truncate">Map Window</span>
                    </span>
                    <svg class="col-start-1 row-start-1 size-5 self-center justify-self-end text-gray-500 sm:size-4" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                      <path fill-rule="evenodd" d="M5.22 10.22a.75.75 0 0 1 1.06 0L8 11.94l1.72-1.72a.75.75 0 1 1 1.06 1.06l-2.25 2.25a.75.75 0 0 1-1.06 0l-2.25-2.25a.75.75 0 0 1 0-1.06ZM10.78 5.78a.75.75 0 0 1-1.06 0L8 4.06 6.28 5.78a.75.75 0 0 1-1.06-1.06l2.25-2.25a.75.75 0 0 1 1.06 0l2.25 2.25a.75.75 0 0 1 0 1.06Z" clip-rule="evenodd" />
                    </svg>
                  </button>
              
                  <ul id="select-list-bbox" class="hidden absolute z-10 mt-1 max-h-56 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black/5 focus:outline-none sm:text-sm" tabindex="-1" role="listbox" aria-labelledby="listbox-label" aria-activedescendant="listbox-option-3">
                    <li class="relative cursor-default select-none py-2 pl-3 pr-9 text-gray-900" id="listbox-option-0" role="option">
                      <div class="flex items-center">
                        <i class="fa-regular fa-square"></i>
                        <span class="ml-3 block truncate font-normal">Map Window</span>
                      </div>
                      <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-indigo-600">
                        <svg class="size-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                          <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.05-.143Z" clip-rule="evenodd" />
                        </svg>
                      </span>
                    </li>
                    <!-- More items... -->
                    <li class="relative cursor-default select-none py-2 pl-3 pr-9 text-gray-900" id="listbox-option-1" role="option">
                      <div class="flex items-center">
                        <i class="fa-solid fa-draw-polygon"></i>
                        <span class="ml-3 block truncate font-normal">Draw AOI on Map</span>
                      </div>
                      <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-indigo-600">
                        <svg class="size-0" viewBox="" fill="currentColor" aria-hidden="true">
                          <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.05-.143Z" clip-rule="evenodd" />
                        </svg>
                      </span>
                    </li>
                    <li class="relative cursor-default select-none py-2 pl-3 pr-9 text-gray-900" id="upload-file-option" role="option">
                      <div class="flex items-center">
                        <i class="fa-solid fa-arrow-up-from-bracket"></i>
                        <span class="ml-3 block truncate font-normal">Upload File</span>
                      </div>
                      <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-indigo-600">
                        <svg class="size-0" viewBox="" fill="currentColor" aria-hidden="true">
                          <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.05-.143Z" clip-rule="evenodd" />
                        </svg>
                      </span>
                    </li>
                  </ul>
                </div>
                <!-- dropdown end -->
                <div class = "mt-1 p-1 border border-gray-300 w-full bg-white">
                  <div id="map-window-content" class = "break-words w-64 text-xs text-gray-500" >

                  </div>
                  <div id = "draw-bbox-option" class="hidden">
                    <div class="draw-buttons"> <button id="draw-point" title="Draw Point" class=" hover:bg-gray-50"><i class="fas fa-map-marker-alt"></i> Point</button> 
                      <button id="draw-polygon" title="Draw Polygon" class=" hover:bg-gray-50"><i class="fas fa-draw-polygon"></i> Polygon</button> 
                      <button id="draw-rectangle" title="Draw Rectangle" class=" hover:bg-gray-50"><i class="fas fa-vector-square"></i> Rectangle</button> </div>
                  </div>
                  <div id = "upload-bbox-file-option" class="hidden">
                      <span>This is upload bbox section</span>
                  </div>
                </div>
                <div>

                </div>
                </div>

                <div>
                  <button id="setFormula-export" class="w-full bg-white text-gray-500 border-gray-500 rounded-md px-4 py-2 mt-4" style="border: 1px solid #dedede;">Set the formula</button>
                  <div class = "mt-1 p-1 border border-gray-300 w-full bg-white">
                    <label id = "formulaHeading-export" class="block text-xs font-medium text-gray-600 pb-1 pt-1">Custom: <span id="formula-text-export" class = "break-words w-64 text-xs text-gray-500" ></span></label>
                  </div>
                </div>

                <!-- Collapsible List Container -->
                <div class="w-full bg-white rounded-lg">
                  <div class="relative">
                      <button id="collapsibleButton" class="w-full text-left font-medium bg-gray-50 py-2 rounded-md flex items-center justify-between">
                          Options 
                          <svg id="arrowIcon" class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                          </svg>
                      </button>
                      <ul id="collapsibleContent" class="hidden mt-2 bg-white border border-gray-50 rounded-md w-full">
                          <li class="p-2 border-b border-gray-200">
                              <label class="block text-sm font-medium text-gray-900 pb-4">Select Date</label>
                              <div class="relative h-10 w-full min-w-[200px] mb-4">
                                  <input id="start-date-export" class="bg-white my-dates peer h-full w-full rounded-[7px] border border-blue-gray-200 border-t-transparent bg-transparent px-3 py-2.5 font-sans text-sm font-normal text-blue-gray-700 outline outline-0 transition-all placeholder-shown:border placeholder-shown:border-blue-gray-200 placeholder-shown:border-t-blue-gray-200 focus:border-2 focus:border-gray-900 focus:border-t-transparent focus:outline-0 disabled:border-0 disabled:bg-blue-gray-50" placeholder=" "/>
                                  <label class="before:content[' '] after:content[' '] pointer-events-none absolute left-0 -top-1.5 flex h-full w-full select-none !overflow-visible truncate text-[11px] font-normal leading-tight text-gray-500 transition-all before:pointer-events-none before:mt-[6.5px] before:mr-1 before:box-border before:block before:h-1.5 before:w-2.5 before:rounded-tl-md before:border-t before:border-l before:border-blue-gray-200 before:transition-all after:pointer-events-none after:mt-[6.5px] after:ml-1 after:box-border after:block after:h-1.5 after:w-2.5 after:flex-grow after:rounded-tr-md after:border-t after:border-r after:border-blue-gray-200 after:transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:leading-[3.75] peer-placeholder-shown:text-blue-gray-500 peer-placeholder-shown:before:border-transparent peer-placeholder-shown:after:border-transparent peer-focus:text-[11px] peer-focus:leading-tight peer-focus:text-gray-900 peer-focus:before:border-t-2 peer-focus:before:border-l-2 peer-focus:before:!border-gray-900 peer-focus:after:border-t-2 peer-focus:after:border-r-2 peer-focus:after:!border-gray-900 peer-disabled:text-transparent peer-disabled:before:border-transparent peer-disabled:after:border-transparent peer-disabled:peer-placeholder-shown:text-blue-gray-500">
                                    Start Date
                                  </label>
                              </div>
                              <div class="relative h-10 w-full min-w-[200px]">
                                  <input id="end-date-export" class="bg-white my-dates peer h-full w-full rounded-[7px] border border-blue-gray-200 border-t-transparent bg-transparent px-3 py-2.5 font-sans text-sm font-normal text-blue-gray-700 outline outline-0 transition-all placeholder-shown:border placeholder-shown:border-blue-gray-200 placeholder-shown:border-t-blue-gray-200 focus:border-2 focus:border-gray-900 focus:border-t-transparent focus:outline-0 disabled:border-0 disabled:bg-blue-gray-50" placeholder=" "/>
                                  <label id = "" class="before:content[' '] after:content[' '] pointer-events-none absolute left-0 -top-1.5 flex h-full w-full select-none !overflow-visible truncate text-[11px] font-normal leading-tight text-gray-500 transition-all before:pointer-events-none before:mt-[6.5px] before:mr-1 before:box-border before:block before:h-1.5 before:w-2.5 before:rounded-tl-md before:border-t before:border-l before:border-blue-gray-200 before:transition-all after:pointer-events-none after:mt-[6.5px] after:ml-1 after:box-border after:block after:h-1.5 after:w-2.5 after:flex-grow after:rounded-tr-md after:border-t after:border-r after:border-blue-gray-200 after:transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:leading-[3.75] peer-placeholder-shown:text-blue-gray-500 peer-placeholder-shown:before:border-transparent peer-placeholder-shown:after:border-transparent peer-focus:text-[11px] peer-focus:leading-tight peer-focus:text-gray-900 peer-focus:before:border-t-2 peer-focus:before:border-l-2 peer-focus:before:!border-gray-900 peer-focus:after:border-t-2 peer-focus:after:border-r-2 peer-focus:after:!border-gray-900 peer-disabled:text-transparent peer-disabled:before:border-transparent peer-disabled:after:border-transparent peer-disabled:peer-placeholder-shown:text-blue-gray-500">
                                    End Date
                                  </label>
                              </div>
                          </li>
                          <li class="p-2 border-b border-gray-200">
                              <label class="block text-sm/6 font-medium text-gray-900 pb-1">Select Cloud Cover <i title = "Less than the input value in percentage" class="fa-solid fa-circle-info"></i></label>
                              <div class="bg-white mt-4">
                                  <div class="relative bg-inherit">
                                      <input type="number" id="cloud-cover-export" name="" value="50" class="peer bg-transparent h-10 w-full rounded-lg text-gray-900 placeholder-transparent ring-1 px-2 ring-gray-200 focus:ring-sky-600 focus:outline-none focus:border-rose-600" placeholder="Cloud Cover"/>
                                      <label for="" class="absolute cursor-text left-0 -top-3 text-sm text-gray-500 bg-inherit mx-1 px-1 peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500 peer-placeholder-shown:top-2 peer-focus:-top-3 peer-focus:text-sky-600 peer-focus:text-sm transition-all">Cloud Cover</label>
                                  </div>
                              </div>
                          </li>
                          <!-- Additional list items can be added here -->
                      </ul>
                  </div>
                </div>

                <div class="w-full">
                  <label class="block text-sm font-medium text-gray-700">Operation</label>
                  <select id="operation_menu" style = "border:1px solid #dedede;" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                      <option value="min">Select Option</option>
                      <option value="min">Min</option>
                      <option value="max">Max</option>
                      <option value="mean">Mean</option>
                      <option value="median">Median</option>
                  </select>
              </div>

              <div class="pb-4 mt-6 float-right">
                <button id="export-clear-button" class="clear-visualize-filter bg-transparent rounded-lg text-gray-500 text-sm text-center self-center px-3 py-2 my-2 mx-2"><i class="fa-solid fa-rotate-right"></i> Clear</button>
                <button id="export-map-view-button" title= "Select Filter Above to Visualize" class="bg-gray-500 pointer-events-none text-white rounded-lg text-sm text-center self-center px-3 py-2 my-2 mx-2"><i class="fa-regular fa-eye"></i> Visualize</button>
                <button id="export-file-button" title= "Select Filter Above to Visualize" class="bg-gray-500 pointer-events-none text-white rounded-lg text-sm text-center self-center px-3 py-2 my-2 mx-2"><i class="fa-regular fa-eye"></i> Export</button>
              </div>

              </div>
            </div>
          </div>
        </div>
      </div>

  </div>
  <div id="map" class = "w-full md:w-3/4 min-h-screen md:min-h-full z-0"></div>

  <!-- filter modal start -->
  <div id="modal" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden z-40">
    <div class="bg-white rounded-lg shadow-lg p-6 w-2/5 relative">
      <button id="closeModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
      </button>
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Finalize the formula to generate the result</h3>
      <label class="block font-xs text-gray-500 pb-4">Double click on the Bands and Operators to select them.</label>
      
      <!-- Section for mapping bands -->
      <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Map Bands</label>
          <div class="flex flex-col md:flex-row md:space-x-4">
              <div class="w-full md:w-1/2 mb-4 md:mb-0">
                  <label class="block text-sm font-medium text-gray-700">Band 1</label>
                  <select id="band1" style = "border:1px solid #dedede;" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                      <option value="">Select Band 1</option>
                      <option value="RED">RED</option>
                      <option value="GREEN">GREEN</option>
                      <option value="BLUE">BLUE</option>
                      <option value="VISUAL">VISUAL</option>
                      <option value="NIR">NIR</option>
                      <option value="SWIR22">SWIR22</option>
                      <option value="REDEDGE2">REDEDGE2</option>
                      <option value="REDEDGE3">REDEDGE3</option>
                      <option value="REDEDGE1">REDEDGE1</option>
                      <option value="SWIR16">SWIR16</option>
                      <option value="WVP">WVP</option>
                      <option value="NIR08">NIR08</option>
                      <option value="SCL">SCL</option>
                      <option value="AOT">AOT</option>
                      <option value="COASTAL">COASTAL</option>
                      <option value="NIR09">NIR09</option>
                      <option value="CLOUD">CLOUD</option>
                      <option value="SNOW">SNOW</option>
                  </select>
              </div>
              <div class="w-full md:w-1/2">
                  <label class="block text-sm font-medium text-gray-700">Band 2</label>
                  <select id="band2" style = "border:1px solid #dedede;" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                      <option value="">Select Band 2</option>
                      <option value="RED">RED</option>
                      <option value="GREEN">GREEN</option>
                      <option value="BLUE">BLUE</option>
                      <option value="VISUAL">VISUAL</option>
                      <option value="NIR">NIR</option>
                      <option value="SWIR22">SWIR22</option>
                      <option value="REDEDGE2">REDEDGE2</option>
                      <option value="REDEDGE3">REDEDGE3</option>
                      <option value="REDEDGE1">REDEDGE1</option>
                      <option value="SWIR16">SWIR16</option>
                      <option value="WVP">WVP</option>
                      <option value="NIR08">NIR08</option>
                      <option value="SCL">SCL</option>
                      <option value="AOT">AOT</option>
                      <option value="COASTAL">COASTAL</option>
                      <option value="NIR09">NIR09</option>
                      <option value="CLOUD">CLOUD</option>
                      <option value="SNOW">SNOW</option>
                  </select>
              </div>
          </div>
      </div>
  
      <!-- Initially hidden section -->
      <div id="bandsSection">
          <div class="mb-4 flex flex-col md:flex-row md:space-x-4">
              <div class="w-full md:w-1/2 mb-4 md:mb-0">
                  <label class="block text-sm font-medium text-gray-700">Bands</label>
                  <div class="mt-1 border border-gray-300 rounded-md p-2 min-h-40 max-h-40 overflow-auto custom-scrollbar" id="attributes-list">
                      <ul class="cursor-pointer text-gray-500 text-sm uppercase" id="mapped-bands">
                          <!-- Mapped bands will be appended here -->
                      </ul>
                  </div>
              </div>
              <div class="w-full md:w-1/2">
                  <label class="block text-sm font-medium text-gray-700">Operators</label>
                  <div class="grid grid-cols-5 gap-2 mt-1 text-gray-500 text-sm" id="operators-list">
                      <button class="operator-item bg-gray-200 rounded-md p-2">7</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">8</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">9</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">(</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">)</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">4</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">5</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">6</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">+</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">-</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">1</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">2</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">3</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">*</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">/</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">0</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">.</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">PI(P)</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">e</button>
                      <button class="operator-item bg-gray-200 rounded-md p-2">^</button>
                  </div>
              </div>
          </div>
          
          <div class="mb-4">
              <label for="query" class="block text-sm font-medium text-gray-700">Query</label>
              <textarea id="query" rows="3" class="mt-1 p-2 text-gray-800 block w-full border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm pointer-events-none"></textarea>
          </div>
          <div class="flex justify-between float-right">
              <button id="resetButton" class="text-gray-500 mr-2"><i class="fa-solid fa-rotate-right"></i> Reset</button>  
              <button id="saveFormula" class="bg-blue-500 text-white rounded-md px-4 py-2">Save</button>
          </div>
      </div>
  </div>
  
  </div>
  <!-- filter modal end -->

  <!-- upload modal start -->
  <div id="uploadModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center hidden z-40">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-lg">
        <h2 class="text-2xl font-semibold mb-4">Upload or Paste GeoJSON File</h2>
        
        <!-- Drag and Drop or Upload Section -->
        <div class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-4 text-center mb-4" id="upload-area">
            <p class="mb-2">Drag & Drop GeoJSON File Here <br/><label>or</label><br/><br/> <input type="file" id="file-input" class="hidden" /><label for="file-input" class="upload-button bg-blue-500 text-white px-4 py-2 rounded-md cursor-pointer">Browse Files</label></p>
        </div>
        
        <!-- Copy and Paste Section -->
        <div class="textarea-container border-2 border-dashed border-gray-300 rounded-lg p-4">
            <p class="mb-2">Copy and Paste GeoJSON Content Here:</p>
            <textarea id="geojson-textarea" class="w-full h-48 border-none focus:outline-none resize-none" placeholder="Paste GeoJSON content..."></textarea>
        </div>

        <!-- Close Button -->
        <div class="text-right mt-4">
            <button id="closeModalButton" class="bg-red-500 text-white px-4 py-2 rounded-md">Close</button>
            <button id="saveUploadedData" class="bg-blue-500 text-white rounded-md px-4 py-2">Save</button>
        </div>
    </div>
</div>
   <!-- upload modal end -->

</div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const tabs = document.querySelectorAll('.tab');
      const tabPanels = document.querySelectorAll('.tab-panel');

      tabs.forEach((tab, index) => {
        tab.addEventListener('click', () => {
          tabs.forEach(tab => tab.classList.remove('border-blue-500', 'text-blue-500'));
          tab.classList.add('border-blue-500', 'text-blue-500');
          tabPanels.forEach(panel => panel.classList.add('hidden'));
          tabPanels[index].classList.remove('hidden');
        });
      });

      // Activate the first tab by default
      tabs[0].classList.add('border-blue-500', 'text-blue-500');
      tabPanels[0].classList.remove('hidden');
    });
  </script>

<script>
      document.getElementById("band1").addEventListener("change", updateBandsBox);
    document.getElementById("band2").addEventListener("change", updateBandsBox);

    function updateBandsBox() {
        const band1_v = document.getElementById("band1").value;
        const band2_v = document.getElementById("band2").value;

        tile_params.band1 = band1_v.toLowerCase();
        tile_params.band2 = band2_v.toLowerCase();

        export_params.band1 = band1_v.toLowerCase(); //setting the same params for now.
        export_params.band2 = band2_v.toLowerCase();

        const mappedBands = new Set();

        if (band1_v) {
            mappedBands.add(`Band1 (${band1_v})`);
        }

        if (band2_v) {
            mappedBands.add(`Band2 (${band2_v})`);
        }

        const bandsArray = Array.from(mappedBands);

        const mappedBandsList = document.getElementById("mapped-bands");
        mappedBandsList.innerHTML = bandsArray.map(band => `<li class="attribute-item hover:bg-gray-100 p-1">${band}</li>`).join('');

        // if (bandsArray.length > 0) {
        //     document.getElementById("bandsSection").classList.remove("hidden");
        // } else {
        //     document.getElementById("bandsSection").classList.add("hidden");
        // }
    }
</script>

  <script>
document.addEventListener('DOMContentLoaded', function() {
  const dropdowns = document.querySelectorAll('.relative.mt-2');

  dropdowns.forEach(dropdown => {
    const selectButton = dropdown.querySelector('button[type="button"]');
    const selectList = dropdown.querySelector('ul');
    const listItems = selectList.querySelectorAll('[role="option"]');

    selectButton.addEventListener('click', function() {
      const expanded = selectButton.getAttribute('aria-expanded') === 'true' || false;
      selectButton.setAttribute('aria-expanded', !expanded);
      selectList.classList.toggle('hidden');
    });

    listItems.forEach(item => {
      item.addEventListener('click', function() {
        //activate visualize/search button
        document.getElementById("search-button").classList.remove('bg-gray-500', 'pointer-events-none');
        document.getElementById("search-button").classList.add('bg-blue-700');

        document.getElementById("formulaHeading").classList.add('hidden'); 

        // Update the button text and image/icon with the selected item's data
        const selectedItemText = item.querySelector('.truncate').innerText;
        const selectedItemIcon = item.querySelector('img, i'); // Select either img or i element

        // Update button text
        selectButton.querySelector('.truncate').innerText = selectedItemText;

        // Update button image/icon
        const buttonIcon = selectButton.querySelector('img, i'); // Select either img or i element
        if (selectedItemIcon.tagName === 'IMG') {
          buttonIcon.src = selectedItemIcon.src;
        } else if (selectedItemIcon.tagName === 'I') {
          buttonIcon.className = selectedItemIcon.className;
        }

        // Update the selected class
        listItems.forEach(i => {
          i.classList.remove('bg-indigo-600', 'text-white', 'font-semibold');
          i.querySelector('span').classList.remove('text-white');
        });
        item.classList.add('bg-indigo-600', 'text-white', 'font-semibold');
        item.querySelector('span').classList.add('text-white');

        // Show the checkmark for the selected item
        const checkIcon = item.querySelector('svg');
        listItems.forEach(i => i.querySelector('svg').classList.add('hidden'));
        checkIcon.classList.remove('hidden');

        // Close the select list
        selectButton.setAttribute('aria-expanded', false);
        selectList.classList.add('hidden');

        // Show/Hide content based on the selected option
        const coords = document.getElementById('map-window-content');
        const drawBBoxOption = document.getElementById('draw-bbox-option');
        const uploadBBoxFileOption = document.getElementById('upload-bbox-file-option');

        // Hide all sections first
        coords.classList.add('hidden');
        drawBBoxOption.classList.add('hidden');
        uploadBBoxFileOption.classList.add('hidden');

        // Show the corresponding section based on the selected item
        if (selectedItemText === 'Map Window') {
          coords.classList.remove('hidden');
        } else if (selectedItemText === 'Draw AOI on Map') {
          drawBBoxOption.classList.remove('hidden');
        } else if (selectedItemText === 'Upload File') {
          uploadBBoxFileOption.classList.remove('hidden');
        }
      });
    });

    document.addEventListener('click', function(event) {
      if (!dropdown.contains(event.target)) {
        selectButton.setAttribute('aria-expanded', false);
        selectList.classList.add('hidden');
      }
    });
  });
});

//if template provided options clicked eg. NDVI, NDWI
document.querySelectorAll('.template-filters').forEach(function(item) {
    item.addEventListener('click', function() {
        const templateText = item.querySelector('.template-filters-value').getAttribute('value');
        // console.log(templateText); 

      if(templateText == "NDVI"){
        tile_params.formula = "(band2 - band1) / (band2 + band1)";
        tile_params.band1 = 'red';
        tile_params.band2 = 'nir';
      }
      else if(templateText == "NDWI"){
        tile_params.formula = "(band2 - band1) / (band2 + band1)";
        tile_params.band1 = 'swir22';
        tile_params.band2 = 'nir';
      }
      
    });
});

    
  </script>
  


    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script>
      var map = L.map("map").setView([28.202082, 83.987222], 10);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      var geojsonLayer;
      var ndviLayer;
      var highlightedLayer = L.layerGroup();
      var clickedResultList = false;
      var previousListMouseIn;

      var tile_params = {
          "bbox": "",                  
          "startDate": "",         
          "endDate": "",           
          "cloudCover": 30,        
          "band1": "visual",        
          "band2": "nir",           
          "formula": "band1"
      }

      var export_params = {
        "min_x": 83.36975097656251,
        "min_y": 27.839076094777816,
        "max_x": 84.60433959960939,
        "max_y": 28.56281321321839,
        "startDdate": "2024-01-02",
        "endDate": "2025-01-01",
        "cloudCover": 30,
        "formula": "(band2 - band1) / (band2 + band1)",
        "band1": "red",
        "band2": "nir",
        "operation": "mean",
        "export_band": "visual",
        "output_dir": "output"
      }

      // var formula = "(band2-band1)/(band2+band1)";
      // var band1 = "red";
      // var band2 = "nir";

      var bounds = map.getBounds();
      tile_params.bbox = `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}`;
      document.getElementById("coords").textContent = tile_params.bbox;
      document.getElementById("zoom-level").textContent = map.getZoom();

      export_params.max_x = bounds.getEast();
      export_params.max_y = bounds.getNorth();
      export_params.min_x = bounds.getWest();
      export_params.min_y = bounds.getSouth();

      map.on("moveend", function () {
        bounds = map.getBounds();
        tile_params.bbox = `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}`;
        document.getElementById("coords").textContent = tile_params.bbox;
        document.getElementById("zoom-level").textContent = map.getZoom();
        
        //change this to if this tab is active or draw or upload is not done. this is for testing now.
        export_params.max_x = bounds.getEast();
        export_params.max_y = bounds.getNorth();
        export_params.min_x = bounds.getWest();
        export_params.min_y = bounds.getSouth();
      });

      document
        .getElementById("search-button")
        .addEventListener("click", function () {
          //goto next tab to show result
          document.getElementById("resultTab").click();

          var bounds = map.getBounds();
          tile_params.bbox = `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}`;
          tile_params.startDate = document.getElementById("start-date").value;
          tile_params.endDate = document.getElementById("end-date").value;
          tile_params.cloudCover = document.getElementById("cloud-cover").value;

          export_params.startDdate = document.getElementById("start-date").value;
          export_params.endDate = document.getElementById("end-date").value;
          export_params.cloudCover = document.getElementById("cloud-cover").value;
          var overlayNdvi = function(){if(document.getElementById("selected_filter_value").value() == "NDVI"){ return true} else{return false} };

          function createPopup(feature){
            var popupContent = `
              <div class="popup-content max-h-72 overflow-y-auto custom-scrollbar p-2">
                <div class="mb-2">
                  <strong class="text-base text-gray-800">${feature.id}</strong>
                </div>
                <div class="mb-2">
                  <strong class="text-xs text-gray-600">Date:</strong>
                  <span class="text-xs text-gray-500">${feature.properties.datetime}</span>
                </div>
                <div class="mb-2">
                  <strong class="text-xs text-gray-600">Cloud Cover:</strong>
                  <span class="text-xs text-gray-500">${feature.properties["eo:cloud_cover"]}</span>
                </div>
                <hr class="my-2">
                <div class="mb-2">
                  <strong class="text-xs">Properties:</strong>
                  <div class="max-w-md overflow-x-auto custom-scrollbar">
                    <table class="min-w-full table-fixed divide-y divide-gray-200">
                      <!--<thead class="bg-gray-50">
                        <tr>
                          <th scope="col" class="w-1/3 px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Key</th>
                          <th scope="col" class="w-2/3 px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
                        </tr>
                      </thead>-->
                      <tbody class="bg-white divide-y divide-gray-200">
                        ${Object.entries(feature.properties).map(([key, value], index) =>
                          `<tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                            <td class="w-1/3 px-2 py-1 text-xs text-gray-500 break-words">${key}</td>
                            <td class="w-2/3 px-2 py-1 text-xs text-gray-900 break-words">${value}</td>
                          </tr>`).join("")}
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="download-section mt-2">
                  <h4 class="text-sm font-semibold">Download</h4>
                  <ul class="list-disc list-inside text-xs">
                    ${Object.entries(feature.assets).map(([key, asset]) =>
                      `<li><a href="${asset.href}" target="_blank" class="text-indigo-600 hover:underline break-words">${asset.title}</a></li>`
                    ).join("")}
                  </ul>
                </div>
              </div>
            `;
            return popupContent;
          }


          function createLayer(feature){
            var layerCreated = L.geoJSON(feature, {
                    style: function () {
                      return {
                        fillOpacity: 0.5,
                        color: "yellow",
                        weight: 2,
                      };
                    },
                  });
            return layerCreated;
          }

          fetch(
            `/search?bbox=${tile_params.bbox}&start_date=${tile_params.startDate}&end_date=${tile_params.endDate}&cloud_cover=${tile_params.cloudCover}`
          )
            .then((response) => response.json())
            .then((data) => {
              if (geojsonLayer) {
                map.removeLayer(geojsonLayer);
              }

              geojsonLayer = L.geoJSON(data, {
                style: function (feature) {
                  return {
                    fillOpacity: 0,
                    color: "red",
                    weight: 1,
                  };
                },
                onEachFeature: function (feature, layer) {
                  layer.on("click", function () {
                    if (Object.keys(highlightedLayer._layers).length > 0) {
                      // map.removeLayer(highlightedLayer);
                      highlightedLayer.clearLayers();
                      
                    }
                    var clickedLayer = createLayer(feature);
                    highlightedLayer.addLayer(clickedLayer);
                    highlightedLayer.addTo(map);
                    // map.fitBounds(clickedLayer.getBounds());
                    map.fitBounds(geojsonLayer.getBounds());
                    
                    layer.bindPopup(createPopup(feature)/*, { keepInView: true }*/).openPopup();

                    // Add event listener for download section toggle
                    document
                      .querySelector(".download-section h4")
                      .addEventListener("click", function () {
                        var ul = this.nextElementSibling;
                        ul.style.display =
                          ul.style.display === "none" ? "block" : "none";
                      });
                  });
                },
              }).addTo(map);

              var featureList = document.getElementById("feature-list");
              featureList.innerHTML = "";
              
              //add count of images
              console.log("count "+data.features.length);
              document.getElementById("display-image-count").innerHTML = `Images: <span class="text-xs">${data.features.length}<span>`;

              data.features.forEach(function (feature, index) {
                var featureItem = document.createElement("div");
                featureItem.className = "feature-item";
                featureItem.innerHTML = `
                            <ul role="list" class="divide-y divide-gray-100">
                              <li id = "result_list_${index}" class="result-list-items flex justify-between gap-x-6 py-5 hover:bg-gray-100 transition-colors duration-300 cursor-pointer">
                                <div class="flex min-w-0 gap-x-4">
                                  <img class="size-12 flex-none rounded-full bg-gray-50" src="static/img/satellite-basemap.png" alt="">
                                  <div class="min-w-0 flex-auto">
                                    <p class="text-sm/6 font-semibold text-gray-900">${feature.id}</p>
                                    <p class="mt-1 truncate text-xs/5 text-gray-500">${feature.properties.datetime}</p>
                                  </div>
                                </div>
                                <div class="hidden shrink-0 sm:flex sm:flex-col sm:items-end">
                                  <!--<p class="text-sm/6 text-gray-900">Co-Founder / CEO</p>-->
                                  <p class="mt-1 text-xs/5 text-gray-400"><i class="fa-solid fa-cloud"></i> ${parseInt(feature.properties["eo:cloud_cover"])} % </time></p>
                                  <!--<p class="result-icons text-sm/6 text-gray-500 hover:text-gray-900"><i id = "result_icon_${index}" class="fa-regular fa-eye"></i></p>-->
                                </div>
                              </li>            
                        `;
                featureItem.addEventListener("mouseleave", function (e) {
                  console.log(previousListMouseIn);
                  console.log(e.target.querySelector('.result-list-items').id);
                  console.log(clickedResultList);
                  if (Object.keys(highlightedLayer._layers).length > 0) {
                    // map.removeLayer(highlightedLayer);
                    if(clickedResultList == false && previousListMouseIn != e.target.querySelector('.result-list-items').id){
                      map.closePopup();
                      highlightedLayer.clearLayers();
                      console.log("entered")
                    }
                    else if(previousListMouseIn == e.target.querySelector('.result-list-items').id){
                      map.removeLayer(highlightedLayer);
                    }
                    
                  }
                  previousListMouseIn = e.target.querySelector('.result-list-items').id;
                });
                featureItem.addEventListener("mouseenter", function (e) {
                  if (Object.keys(highlightedLayer._layers).length > 0) {
                    map.closePopup();
                    highlightedLayer.clearLayers();
                  }
                  var hoveredLayer = createLayer(feature);
                  // if(previousListMouseIn != e.target.querySelector('.result-list-items').id){
                    
                    highlightedLayer.addLayer(hoveredLayer);
                    
                    // console.log(e)
                    
                    hoveredLayer.bindPopup(createPopup(feature));
                  // }
                  // else{

                  // }
                  highlightedLayer.addTo(map);
                  // map.fitBounds(hoveredLayer.getBounds());
                  map.fitBounds(geojsonLayer.getBounds());
                  

                  // document
                  //   .querySelector(".download-section h4")
                  //   .addEventListener("click", function () {
                  //     var ul = this.nextElementSibling;
                  //     ul.style.display =
                  //       ul.style.display === "none" ? "block" : "none";
                  //   });
                 
                  clickedResultList = false;
                  

                });

                featureItem.addEventListener("click", function () {
                  // console.log(highlightedLayer.getLayers()[0]);
                  highlightedLayer.getLayers()[0].openPopup();
                  clickedResultList = true;
                })
                featureList.appendChild(featureItem);
              });

              document.getElementById("sidebar").style.display = "block";

              if (overlayNdvi) {
                if (ndviLayer) {
                  map.removeLayer(ndviLayer);
                }
                
                const encodedUrl_tiles = `/tile/{z}/{x}/{y}?start_date=${encodeURIComponent(tile_params.startDate)}&end_date=${encodeURIComponent(tile_params.endDate)}&cloud_cover=${encodeURIComponent(tile_params.cloudCover)}&formula=${encodeURIComponent(tile_params.formula)}&band1=${encodeURIComponent(tile_params.band1)}&band2=${encodeURIComponent(tile_params.band2)}`;
                ndviLayer = L.tileLayer(
                  encodedUrl_tiles,
                  {
                    tileSize: 256,
                    opacity: 0.8,
                    attribution:
                      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                  }
                ).addTo(map);
              }
            });
        });

      document
        .getElementById("clear-sidebar-button")
        .addEventListener("click", function () {
          if (geojsonLayer) {
            map.removeLayer(geojsonLayer);
          }
          if (highlightedLayer) {
            map.removeLayer(highlightedLayer);
          }
          if (ndviLayer) {
            map.removeLayer(ndviLayer);
          }
          document.getElementById("feature-list").innerHTML = '<label class="block text-sm font-medium text-gray-400 pt-4">Apply the Filter First!!!</label>';
          setDefaultFilters();
          setDefaultFiltersExport();

          document.getElementById("display-image-count").innerHTML = `Images: `;
        });

        document
        .getElementById("search-clear-button")
        .addEventListener("click", function () {
          document.getElementById("clear-sidebar-button").click();
        })

        document
        .getElementById("export-clear-button")
        .addEventListener("click", function () {
          document.getElementById("clear-sidebar-button").click();

        })

      function setDefaultFilters(){
        // Set default dates
        var today = new Date().toISOString().split("T")[0];
        var lastYear = new Date();
        lastYear.setFullYear(lastYear.getFullYear() - 1);
        var lastYearDate = lastYear.toISOString().split("T")[0];

        document.getElementById("start-date").value = lastYearDate;
        document.getElementById("end-date").value = today;

        document.getElementById("cloud-cover").value = "50";

        document.getElementById("select-button").innerHTML = `<span class="col-start-1 row-start-1 flex items-center gap-3 pr-6">
                      <img src="static/img/select-icon.png" alt="" class="size-5 shrink-0 rounded-full">
                      <span id = "selected_filter_value" class="block truncate">Select Option</span>
                    </span>`;

        document.getElementById("search-button").classList.add('bg-gray-500', 'pointer-events-none');
        document.getElementById("search-button").classList.remove('bg-blue-700');
      }
      setDefaultFilters();

      function setDefaultFiltersExport(){
        // Set default dates
        var today = new Date().toISOString().split("T")[0];
        var lastYear = new Date();
        lastYear.setFullYear(lastYear.getFullYear() - 1);
        var lastYearDate = lastYear.toISOString().split("T")[0];

        document.getElementById("start-date-export").value = lastYearDate;
        document.getElementById("end-date-export").value = today;

        document.getElementById("cloud-cover-export").value = "50";

        document.getElementById("export-map-view-button").classList.add('bg-gray-500', 'pointer-events-none');
        document.getElementById("export-map-view-button").classList.remove('bg-blue-700');

        document.getElementById("operation_menu").value = "Select Option";
      }
      setDefaultFiltersExport();



//draw start    
// Initialize the FeatureGroup to store editable layers
var drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

// Initialize the draw control and pass it the FeatureGroup of editable layers
var drawControl = new L.Control.Draw({
    edit: {
        featureGroup: drawnItems
    },
    draw: false // Disable built-in draw options
});
map.addControl(drawControl);

// Draw handlers
var drawHandlers = {
    point: new L.Draw.Marker(map),
    polygon: new L.Draw.Polygon(map),
    rectangle: new L.Draw.Rectangle(map)
};

// Draw buttons event listeners
document.getElementById('draw-point').addEventListener('click', function () {
    // Clear existing layers before drawing a new one
    drawnItems.clearLayers();
    drawHandlers.point.enable();
});
document.getElementById('draw-polygon').addEventListener('click', function () {
    // Clear existing layers before drawing a new one
    drawnItems.clearLayers();
    drawHandlers.polygon.enable();
});
document.getElementById('draw-rectangle').addEventListener('click', function () {
    // Clear existing layers before drawing a new one
    drawnItems.clearLayers();
    drawHandlers.rectangle.enable();
});

// Convert radius in meters to degrees 
function metersToDegrees(meters) { 
    const earthRadius = 6371000; // in meters 
    const degToRad = Math.PI / 180; 
    const radToDeg = 180 / Math.PI; 
    const deltaDeg = meters / (earthRadius * degToRad); 
    return deltaDeg * radToDeg; 
}

// Event for creating new layers
map.on(L.Draw.Event.CREATED, function (event) {
    // Clear existing layers before adding the new layer
    drawnItems.clearLayers();

    var layer = event.layer;
    drawnItems.addLayer(layer);

    // var bbox;

    if (!(layer instanceof L.Marker)) {
        var bd = layer.getBounds();
        // tile_params.bbox = `${bd.getWest()},${bd.getSouth()},${bd.getEast()},${bd.getNorth()}`;
        export_params.max_x = bd.getEast();
        export_params.max_y = bd.getNorth();
        export_params.min_x = bd.getWest();
        export_params.min_y = bd.getSouth();

    } else {
        var radiusInMeters = 1000; // Example radius in meters
        var radiusInDegrees = metersToDegrees(radiusInMeters);

        var latlng = layer.getLatLng();
        var lat = latlng.lat;
        var lng = latlng.lng;

        // tile_params.bbox = `${lng - radiusInDegrees},${lat - radiusInDegrees},${lng + radiusInDegrees},${lat + radiusInDegrees}`;
        export_params.max_x = lng + radiusInDegrees;
        export_params.max_y = lat + radiusInDegrees;
        export_params.min_x = lng - radiusInDegrees;
        export_params.min_y = lat - radiusInDegrees;
    }
});

      
    </script>


    <!-- export /compute api start -->
    <script>
      document.getElementById("export-map-view-button").addEventListener('click', function() {
        const url_compute = `/compute?min_x=${export_params.min_x}&min_y=${export_params.min_y}&max_x=${export_params.max_x}&max_y=${export_params.max_y}&start_date=${encodeURIComponent(export_params.startDdate)}&end_date=${encodeURIComponent(export_params.endDate)}&cloud_cover=${export_params.cloudCover}&formula=${encodeURIComponent(export_params.formula)}&band1=${encodeURIComponent(export_params.band1)}&band2=${encodeURIComponent(export_params.band2)}&operation=${encodeURIComponent(export_params.operation)}&export_band=${encodeURIComponent(export_params.export_band)}&output_dir=${encodeURIComponent(export_params.output_dir)}`;

        console.log(url_compute);
        
        fetch(url_compute, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(export_params)
        })
        .then(response => response.json())
        .then(data => {
          console.log('Success:', data);
        })
        .catch((error) => {
          console.error('Error:', error);
        });
      });

    </script>
    <!-- export /compute api end -->

    <!-- operation script start  -->
    <script>
      document.getElementById("operation_menu").addEventListener('change', function() {
        export_params.operation = this.value;
        document.getElementById("export-map-view-button").classList.remove('bg-gray-500', 'pointer-events-none');
        document.getElementById("export-map-view-button").classList.add('bg-blue-700');
      });

    </script>
    <!-- operation script end -->

    <!-- upload modal script start -->
    <script>
      const uploadArea = document.getElementById('upload-area');
      const fileInput = document.getElementById('file-input');
      const textarea = document.getElementById('geojson-textarea');
      const openModalButton = document.getElementById('upload-file-option');
      const closeModalButton = document.getElementById('closeModalButton');
      const uploadModal = document.getElementById('uploadModal');
      
      // Open modal
      openModalButton.addEventListener('click', function() {
          uploadModal.classList.remove('hidden');
      });
  
      // Close modal
      closeModalButton.addEventListener('click', function() {
          uploadModal.classList.add('hidden');
      });
  
      // Handle drag and drop
      uploadArea.addEventListener('dragover', function(e) {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.classList.add('dragover');
      });
  
      uploadArea.addEventListener('dragleave', function(e) {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.classList.remove('dragover');
      });
  
      uploadArea.addEventListener('drop', function(e) {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.classList.remove('dragover');
          const files = e.dataTransfer.files;
          handleFileUpload(files[0]);
      });
  
      // Handle file input change
      fileInput.addEventListener('change', function(e) {
          const files = e.target.files;
          handleFileUpload(files[0]);
      });
  
      // Function to handle file upload
      function handleFileUpload(file) {
          const reader = new FileReader();
          reader.onload = function(event) {
              textarea.value = event.target.result;
          };
          reader.readAsText(file);
      }
    </script>

    <!-- upload modal script end -->

    <script>
      const collapsibleButton = document.getElementById('collapsibleButton');
      const collapsibleContent = document.getElementById('collapsibleContent');
      const arrowIcon = document.getElementById('arrowIcon');
  
      // Toggle collapsible content visibility
      collapsibleButton.addEventListener('click', function() {
          collapsibleContent.classList.toggle('hidden');
          arrowIcon.classList.toggle('rotate-180'); // Rotate the arrow icon
      });
  </script>

    <!-- JavaScript to handle modal and populate textarea -->
    <script>
      
     document.addEventListener('DOMContentLoaded', function() {
        const openModalButton = document.getElementById('custom-filter');
        const closeModalButton = document.getElementById('closeModal');
        const modal = document.getElementById('modal');
        const queryTextarea = document.getElementById('query');
        const resetButton = document.getElementById('resetButton');
        const saveFormulaButton = document.getElementById('saveFormula');

        // Function to toggle modal visibility
        function toggleModal() {
            modal.classList.toggle('hidden');
        }

        // Event listeners to open and close the modal
        openModalButton.addEventListener('click', toggleModal);
        closeModalButton.addEventListener('click', toggleModal);

        // Function to append text to the textarea
        function appendToQuery(text) {
            queryTextarea.value += text + ' ';
        }

        // Add double-click event listeners to attributes list items
        document.getElementById('attributes-list').addEventListener('dblclick', function(event) { 
          if (event.target && event.target.classList.contains('attribute-item')) { 
            var separated_band_text = event.target.textContent.split(" ")[0];
            appendToQuery(separated_band_text); 
          } 
        });

        // Add double-click event listeners to operators list items
        document.querySelectorAll('#operators-list .operator-item').forEach(function(item) {
            item.addEventListener('dblclick', function() {
                appendToQuery(item.textContent);
            });
        });

        // Event listener to reset the textarea
        resetButton.addEventListener('click', function() {
            queryTextarea.value = '';  // Clears the content of the textarea
        });

        saveFormulaButton.addEventListener('click', function() {
            tile_params.formula = queryTextarea.value.toLowerCase(); 
            export_params.formula = queryTextarea.value.toLowerCase(); //setting the same formula for now (for search and export)

            console.log('formula:', tile_params.formula);
            document.getElementById("formulaHeading").classList.remove('hidden'); 
            document.getElementById("formulaText").innerHTML = tile_params.formula;
            document.getElementById("formula-text-export").innerHTML = export_params.formula; 
            closeModalButton.click();
        });

        //open formula modal from export section
        document.getElementById("setFormula-export").addEventListener('click', function() {
          document.getElementById("custom-filter").click();
        });
    });



  </script>

  <!-- datepicker start -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Select all elements with the class "my-dates"
      const dateInputs = document.querySelectorAll('.my-dates');
  
      // Initialize Flatpickr for each date input
      dateInputs.forEach(input => {
        const datepicker = flatpickr(input, {});
        console.log("datepicker: ", datepicker);
  
        // Styling the date picker
        const calendarContainer = datepicker.calendarContainer;
        const calendarMonthNav = datepicker.monthNav;
        const calendarNextMonthNav = datepicker.nextMonthNav;
        const calendarPrevMonthNav = datepicker.prevMonthNav;
        const calendarDaysContainer = datepicker.daysContainer;
  
        calendarContainer.className = `${calendarContainer.className} bg-white p-4 border border-blue-gray-50 rounded-lg shadow-lg shadow-blue-gray-500/10 font-sans text-sm font-normal text-blue-gray-500 focus:outline-none break-words whitespace-normal`;
       
        calendarMonthNav.className = `${calendarMonthNav.className} flex items-center justify-between mb-4 [&>div.flatpickr-month]:-translate-y-3`;
       
        calendarNextMonthNav.className = `${calendarNextMonthNav.className} absolute !top-2.5 !right-1.5 h-6 w-6 bg-transparent hover:bg-blue-gray-50 !p-1 rounded-md transition-colors duration-300`;
       
        calendarPrevMonthNav.className = `${calendarPrevMonthNav.className} absolute !top-2.5 !left-1.5 h-6 w-6 bg-transparent hover:bg-blue-gray-50 !p-1 rounded-md transition-colors duration-300`;
       
        calendarDaysContainer.className = `${calendarDaysContainer.className} [&_span.flatpickr-day]:!rounded-md [&_span.flatpickr-day.selected]:!bg-gray-900 [&_span.flatpickr-day.selected]:!border-gray-900`;
      });
    });
  </script>
  
  <!-- export tab script -->
  <script>
    document.getElementById("map-window-content").innerHTML = document.getElementById("coords").textContent;
  </script>
  <!-- export tab script end -->
   
  <!-- datepicker end -->

  </body>
</html>
