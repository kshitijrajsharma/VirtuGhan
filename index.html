<!DOCTYPE html>
<html>
  <head>
    <title>NDVI Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      #map {
        height: 100vh;
      }
      #info {
        position: absolute;
        bottom: 10px;
        z-index: 1000;
        left: 10px;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      }
      #controls {
        position: absolute;
        top: 10px;
        z-index: 1000;
        left: 10px;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="info">
      <strong>Coordinates:</strong> <span id="coords"></span><br />
      <strong>Zoom Level:</strong> <span id="zoom-level"></span>
    </div>
    <div id="controls">
      <label>Start Date: <input type="date" id="start-date" /></label><br />
      <label>End Date: <input type="date" id="end-date" /></label><br />
      <label
        >Cloud Cover: <input type="number" id="cloud-cover" value="30" /></label
      ><br />
      <button id="search-button">Search</button>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      var map = L.map("map").setView([0, 0], 2);

      var openStreetMapLayer = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          maxZoom: 19,
        }
      ).addTo(map);

      var geojsonLayer;
      var ndviLayer;

      map.on("moveend", function () {
        var bounds = map.getBounds();
        var bbox = `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}`;
        document.getElementById("coords").textContent = bbox;
        document.getElementById("zoom-level").textContent = map.getZoom();
      });

      document
        .getElementById("search-button")
        .addEventListener("click", function () {
          var startDate = document.getElementById("start-date").value;
          var endDate = document.getElementById("end-date").value;
          var cloudCover = document.getElementById("cloud-cover").value;
          var bounds = map.getBounds();
          var bbox = `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}`;

          var zoomLevel = map.getZoom();

          if (zoomLevel < 10) {
            alert("Please zoom in to a level greater than 10 to search.");
            return;
          }
          if (geojsonLayer) {
            map.removeLayer(geojsonLayer);
          }

          fetch(
            `http://127.0.0.1:8000/search?bbox=${bbox}&start_date=${startDate}&end_date=${endDate}&cloud_cover=${cloudCover}`
          )
            .then((response) => response.json())
            .then((data) => {
              geojsonLayer = L.geoJSON(data, {
                style: function (feature) {
                  return {
                    fillOpacity: 0,
                    color: "red",
                    weight: 1,
                  };
                },
                onEachFeature: function (feature, layer) {
                  layer.on("click", function () {
                    var popupContent = `
                    <strong>ID:</strong> ${feature.id}<br />
                    <strong>Date:</strong> ${feature.properties.datetime}<br />
                    <strong>Cloud Cover:</strong> ${feature.properties["eo:cloud_cover"]}<br />
                  `;
                    layer.bindPopup(popupContent).openPopup();
                  });
                },
              }).addTo(map);

              if (ndviLayer) {
                map.removeLayer(ndviLayer);
              }

              ndviLayer = L.tileLayer(
                `http://127.0.0.1:8000/tile/{z}/{x}/{y}?start_date=${startDate}&end_date=${endDate}&cloud_cover=${cloudCover}`,
                {
                  tileSize: 256,
                  opacity: 0.8,
                  attribution:
                    '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                }
              ).addTo(map);
            });
        });

      // Set default dates
      var today = new Date().toISOString().split("T")[0];
      var lastYear = new Date();
      lastYear.setFullYear(lastYear.getFullYear() - 1);
      var lastYearDate = lastYear.toISOString().split("T")[0];

      document.getElementById("start-date").value = lastYearDate;
      document.getElementById("end-date").value = today;
    </script>
  </body>
</html>
